<!DOCTYPE html>
<html lang="en">
<head>
  <title>ParseComments.scala</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="../../../../../../res/style.css"></style>
  <script type="text/javascript" 
    src="../../../../../../res/jquery.js"></script>
</head>
<body>
  <div id="container">
    <h1 class="title">ParseComments.scala&nbsp;<span class="change-link">Change</span></h1>
    <ul id="nav-list" class="hidden">
                    
                <li><a href="../../../../../../src/main/scala/com/tristanhunt/sourcedown/CodeStyle.scala.html">src/main/scala/com/tristanhunt/sourcedown/CodeStyle.scala</a></li>
                                
                <li><a href="../../../../../../src/main/scala/com/tristanhunt/sourcedown/ConvertMarkdown.scala.html">src/main/scala/com/tristanhunt/sourcedown/ConvertMarkdown.scala</a></li>
                                
                <li><a href="../../../../../../src/main/scala/com/tristanhunt/sourcedown/ConvertToHTML.scala.html">src/main/scala/com/tristanhunt/sourcedown/ConvertToHTML.scala</a></li>
                                
                <li><a href="../../../../../../src/main/scala/com/tristanhunt/sourcedown/CreateTemplate.scala.html">src/main/scala/com/tristanhunt/sourcedown/CreateTemplate.scala</a></li>
                                
                <li><a href="../../../../../../src/main/scala/com/tristanhunt/sourcedown/Highlight.scala.html">src/main/scala/com/tristanhunt/sourcedown/Highlight.scala</a></li>
                                
                <li class="active">src/main/scala/com/tristanhunt/sourcedown/ParseComments.scala</li>
                                
                <li><a href="../../../../../../src/main/scala/com/tristanhunt/sourcedown/Section.scala.html">src/main/scala/com/tristanhunt/sourcedown/Section.scala</a></li>
                                
                <li><a href="../../../../../../src/main/scala/com/tristanhunt/sourcedown/Sourcedown.scala.html">src/main/scala/com/tristanhunt/sourcedown/Sourcedown.scala</a></li>
                                
                <li><a href="../../../../../../src/test/scala/com/tristanhunt/sourcedown/CreateTemplateSpec.scala.html">src/test/scala/com/tristanhunt/sourcedown/CreateTemplateSpec.scala</a></li>
                                
                <li><a href="../../../../../../src/test/scala/com/tristanhunt/sourcedown/ParseCommentsSpec.scala.html">src/test/scala/com/tristanhunt/sourcedown/ParseCommentsSpec.scala</a></li>
                                
                <li><a href="../../../../../../src/test/scala/com/tristanhunt/sourcedown/RunSourcedownTests.scala.html">src/test/scala/com/tristanhunt/sourcedown/RunSourcedownTests.scala</a></li>
                                
                <li><a href="../../../../../../src/test/scala/com/tristanhunt/sourcedown/TestHelper.scala.html">src/test/scala/com/tristanhunt/sourcedown/TestHelper.scala</a></li>
                        </ul>
    <table><tbody><tr><td><h1>Parsing in Sourcedown</h1><p><strong><em>TODO</em></strong> This needs to ignore strings. (duh)
</p><p>&quot;Start here&quot; to know about parsing in Souredown.
</p><p>Generally speaking, we only care about comments in sourcedown. The
trick is that we care about them in lots of different languages.
</p><p>This takes what we know about a file (typically it's path) and then we
find the suitable parser for the language. What we get out is a stream of
comments or code. Code is defined as &quot;not a comment&quot;.
</p><h2>Class CommentParser</h2><p>The top-level methods that basically go from &quot;file in filesystem&quot; to input
file.
</p><ul><li><code>parse(sourcePath): Seq[Section]</code>
</li><li><code>parse(sourcePath, codeStyle): Seq[Section]</code>
</li></ul></td><td><div class="highlight"><pre><span class="k">package</span> <span class="nn">com.tristanhunt.sourcedown</span>

<span class="k">import</span> <span class="nn">scala.collection.mutable.</span><span class="o">{</span> <span class="nc">ListBuffer</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">scala.util.parsing.input.</span><span class="o">{</span> <span class="nc">Reader</span><span class="o">,</span> <span class="nc">CharSequenceReader</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">scalax.file._</span>

<span class="k">object</span> <span class="nc">ParseComments</span> <span class="o">{</span>
  
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">path</span><span class="k">:</span> <span class="kt">Path</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Section</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">apply</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="nc">CodeStyle</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;unknown&quot;</span><span class="o">)))</span>

  
</pre></div>
</td></tr><tr><td><p>Scans through the entire source file and tries to match it using the
language comment style.
</p><p>This is actually the starting method that manages the resources in use.
</p></td><td><div class="highlight"><pre>  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">path</span><span class="k">:</span> <span class="kt">Path</span><span class="o">,</span> <span class="n">styleOpt</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">CodeStyle</span><span class="o">])</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Section</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>

    
</pre></div>
</td></tr><tr><td><p>Read all characters in the stream
This will use the system's default encoding. Might be a problem.</p></td><td><div class="highlight"><pre>    <span class="k">var</span> <span class="n">content</span> <span class="k">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lines</span><span class="o">(</span><span class="n">includeTerminator</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span>
                      <span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)</span>

    <span class="n">styleOpt</span> <span class="k">match</span> <span class="o">{</span>
      
      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
        <span class="nc">Seq</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="n">content</span><span class="o">))</span>

      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">codeStyle</span><span class="o">)</span> <span class="k">=&gt;</span>

        <span class="k">var</span> <span class="n">reader</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CharSequenceReader</span><span class="o">(</span><span class="n">content</span><span class="o">)</span>
        <span class="k">var</span> <span class="n">tokens</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">Section</span><span class="o">]</span>

        <span class="n">readContent</span><span class="o">(</span><span class="n">codeStyle</span><span class="o">,</span> <span class="n">reader</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">Char</span><span class="o">])</span>

        <span class="k">return</span> <span class="n">createGroups</span><span class="o">(</span><span class="n">tokens</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">matches</span><span class="o">(</span><span class="s">&quot;\\s*&quot;</span><span class="o">)</span> <span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>

  
</pre></div>
</td></tr><tr><td><p>These methods depend upon other methods that basically consume a reader
and append data to input parameters:
</p><ul><li><code>readContent(codeStyle, reader, tokens, buffer)</code> - Assumes we are not
in a comment
</li><li><code>readComment(end, reader, tokens, buffer)</code> - Reads until the end
marker is found
</li></ul><p>TODO right now this might not handle php particularly well, but we'll
just have to see.
</p></td><td><div class="highlight"><pre>  <span class="k">def</span> <span class="n">readContent</span><span class="o">(</span><span class="n">codeStyle</span><span class="k">:</span> <span class="kt">CodeStyle</span><span class="o">,</span> <span class="n">reader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">Char</span><span class="o">],</span> 
                  <span class="n">tokens</span><span class="k">:</span> <span class="kt">ListBuffer</span><span class="o">[</span><span class="kt">Section</span><span class="o">],</span> <span class="n">buffer</span><span class="k">:</span> <span class="kt">ListBuffer</span><span class="o">[</span><span class="kt">Char</span><span class="o">])</span> <span class="o">{</span>

    <span class="k">var</span> <span class="n">pos</span> <span class="k">=</span> <span class="n">reader</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="n">atEnd</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">tokens</span> <span class="o">+=</span> <span class="nc">Code</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span>
      <span class="k">return</span>
    <span class="o">}</span>

    <span class="n">buffer</span> <span class="o">+=</span> <span class="n">pos</span><span class="o">.</span><span class="n">first</span>

    <span class="k">val</span> <span class="n">string</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
      <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">codeStyle</span><span class="o">.</span><span class="n">stringDelimiters</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="n">start</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">)</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">string</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">var</span> <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">)</span> <span class="k">=</span> <span class="n">string</span><span class="o">.</span><span class="n">head</span>
      <span class="k">val</span> <span class="n">nextPos</span> <span class="k">=</span> <span class="n">readString</span><span class="o">(</span><span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">rest</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="n">buffer</span><span class="o">)</span>
      <span class="n">readContent</span><span class="o">(</span><span class="n">codeStyle</span><span class="o">,</span> <span class="n">nextPos</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="n">buffer</span><span class="o">)</span>
      <span class="k">return</span>
    <span class="o">}</span>

    <span class="k">val</span> <span class="n">singleLine</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
      <span class="n">start</span> <span class="k">&lt;-</span> <span class="n">codeStyle</span><span class="o">.</span><span class="n">singleLineStart</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="n">start</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">start</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">singleLine</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">var</span> <span class="n">start</span> <span class="k">=</span> <span class="n">singleLine</span><span class="o">.</span><span class="n">head</span>
      <span class="k">val</span> <span class="n">content</span> <span class="k">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">dropRight</span><span class="o">(</span><span class="n">start</span><span class="o">.</span><span class="n">length</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">content</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span>
        <span class="n">tokens</span> <span class="o">+=</span> <span class="nc">Code</span><span class="o">(</span><span class="n">content</span><span class="o">)</span>
      <span class="n">buffer</span><span class="o">.</span><span class="n">clear</span>
      <span class="k">val</span> <span class="o">(</span><span class="n">comment</span><span class="o">,</span> <span class="n">nextPos</span><span class="o">)</span> <span class="k">=</span> 
        <span class="n">readComment</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">rest</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">Char</span><span class="o">](</span><span class="n">start</span><span class="k">:_</span><span class="kt">*</span><span class="o">),</span> <span class="n">codeStyle</span><span class="o">)</span>
      <span class="n">tokens</span> <span class="o">+=</span> <span class="nc">SingleLineComment</span><span class="o">(</span><span class="n">comment</span><span class="o">,</span> <span class="n">start</span><span class="o">)</span>
      <span class="n">readContent</span><span class="o">(</span><span class="n">codeStyle</span><span class="o">,</span> <span class="n">nextPos</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="n">buffer</span><span class="o">)</span>   
      <span class="k">return</span>
    <span class="o">}</span> 

    <span class="k">val</span> <span class="n">multiMatches</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
      <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">codeStyle</span><span class="o">.</span><span class="n">multiLineEnds</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="n">start</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">)</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">multiMatches</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">var</span> <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">)</span> <span class="k">=</span> <span class="n">multiMatches</span><span class="o">.</span><span class="n">head</span>
      <span class="k">val</span> <span class="n">content</span> <span class="k">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">dropRight</span><span class="o">(</span><span class="n">start</span><span class="o">.</span><span class="n">length</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">content</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span>
        <span class="n">tokens</span> <span class="o">+=</span> <span class="nc">Code</span><span class="o">(</span><span class="n">content</span><span class="o">)</span>
      <span class="n">buffer</span><span class="o">.</span><span class="n">clear</span>
      <span class="k">val</span> <span class="o">(</span><span class="n">comment</span><span class="o">,</span> <span class="n">nextPos</span><span class="o">)</span> <span class="k">=</span> 
        <span class="n">readComment</span><span class="o">(</span><span class="n">end</span><span class="o">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">rest</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">Char</span><span class="o">](</span><span class="n">start</span><span class="k">:_</span><span class="kt">*</span><span class="o">),</span> <span class="n">codeStyle</span><span class="o">)</span>
      <span class="n">tokens</span> <span class="o">+=</span> <span class="nc">MultiLineComment</span><span class="o">(</span><span class="n">comment</span><span class="o">,</span> <span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">)</span>
      <span class="n">readContent</span><span class="o">(</span><span class="n">codeStyle</span><span class="o">,</span> <span class="n">nextPos</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="n">buffer</span><span class="o">)</span>
      <span class="k">return</span>
    <span class="o">}</span>

    <span class="n">readContent</span><span class="o">(</span><span class="n">codeStyle</span><span class="o">,</span> <span class="k">if</span> <span class="o">(</span><span class="n">pos</span><span class="o">.</span><span class="n">atEnd</span><span class="o">)</span> <span class="n">pos</span> <span class="k">else</span> <span class="n">pos</span><span class="o">.</span><span class="n">rest</span><span class="o">,</span> 
          <span class="n">tokens</span><span class="o">,</span> <span class="n">buffer</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">implicit</span> <span class="k">def</span> <span class="n">toString</span><span class="o">(</span><span class="n">seq</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Char</span><span class="o">])</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">seq</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">readComment</span><span class="o">(</span><span class="n">end</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">reader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">Char</span><span class="o">],</span> 
              <span class="n">tokens</span><span class="k">:</span> <span class="kt">ListBuffer</span><span class="o">[</span><span class="kt">Section</span><span class="o">],</span> <span class="n">buffer</span><span class="k">:</span> <span class="kt">ListBuffer</span><span class="o">[</span><span class="kt">Char</span><span class="o">],</span>
              <span class="n">codeStyle</span><span class="k">:</span> <span class="kt">CodeStyle</span><span class="o">)</span> <span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">Char</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="n">atEnd</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">reader</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">buffer</span> <span class="o">+=</span> <span class="n">reader</span><span class="o">.</span><span class="n">first</span>

    <span class="k">var</span> <span class="n">nextPos</span> <span class="k">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">rest</span>

    <span class="k">val</span> <span class="n">string</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
      <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">codeStyle</span><span class="o">.</span><span class="n">stringDelimiters</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="n">start</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">)</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">string</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">var</span> <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">)</span> <span class="k">=</span> <span class="n">string</span><span class="o">.</span><span class="n">head</span>
      <span class="n">nextPos</span> <span class="k">=</span> <span class="n">readString</span><span class="o">(</span><span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">rest</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="n">buffer</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="n">end</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">rest</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">readComment</span><span class="o">(</span><span class="n">end</span><span class="o">,</span> <span class="n">nextPos</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">codeStyle</span><span class="o">)</span>
  <span class="o">}</span>

  
</pre></div>
</td></tr><tr><td><p>Combines sequences of single line comments. We ditch sequences of whitespace
only code blocks in between.
</p></td><td><div class="highlight"><pre>  <span class="k">private</span> <span class="k">def</span> <span class="n">createGroups</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Section</span><span class="o">])</span> <span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Section</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">buffer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">Section</span><span class="o">]</span>
    <span class="k">var</span> <span class="n">group</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">SingleLineComment</span><span class="o">]</span>

    <span class="k">def</span> <span class="n">continue</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">Section</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">group</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">buffer</span> <span class="o">+=</span> <span class="nc">SingleLineGroup</span><span class="o">(</span> <span class="n">group</span> <span class="o">)</span>
        <span class="n">group</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">SingleLineComment</span><span class="o">]</span>
      <span class="o">}</span>
      <span class="n">buffer</span> <span class="o">+=</span> <span class="n">s</span>
    <span class="o">}</span>

    <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="n">in</span><span class="o">.</span><span class="n">length</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">index</span> <span class="k">=&gt;</span>
      <span class="n">in</span><span class="o">(</span><span class="n">index</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">s</span><span class="k">:</span><span class="kt">SingleLineComment</span> <span class="o">=&gt;</span>
          <span class="n">group</span> <span class="o">+=</span> <span class="n">s</span>

        <span class="k">case</span> <span class="n">c</span><span class="k">:</span><span class="kt">Code</span> <span class="o">=&gt;</span>             <span class="n">continue</span><span class="o">(</span><span class="n">c</span><span class="o">)</span>
        <span class="k">case</span> <span class="n">m</span><span class="k">:</span><span class="kt">MultiLineComment</span> <span class="o">=&gt;</span> <span class="n">continue</span><span class="o">(</span><span class="n">m</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">group</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="n">buffer</span> <span class="o">+=</span> <span class="nc">SingleLineGroup</span><span class="o">(</span> <span class="n">group</span> <span class="o">)</span>

    <span class="k">return</span> <span class="n">buffer</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">isSingleLineAt</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Section</span><span class="o">],</span> <span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
    
    <span class="k">var</span> <span class="n">isSingle</span> <span class="k">=</span> <span class="kc">false</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="n">isDefinedAt</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">in</span><span class="o">(</span><span class="n">index</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">s</span><span class="k">:</span><span class="kt">SingleLineComment</span> <span class="o">=&gt;</span> <span class="n">isSingle</span> <span class="k">=</span> <span class="kc">true</span>
        <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>                   <span class="n">isSingle</span> <span class="k">=</span> <span class="kc">false</span>
      <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="k">return</span> <span class="n">isSingle</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">readString</span><span class="o">(</span><span class="n">end</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">escape</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> 
                         <span class="n">reader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">Char</span><span class="o">],</span>
                         <span class="n">tokens</span><span class="k">:</span> <span class="kt">ListBuffer</span><span class="o">[</span><span class="kt">Section</span><span class="o">],</span> 
                         <span class="n">buffer</span><span class="k">:</span> <span class="kt">ListBuffer</span><span class="o">[</span><span class="kt">Char</span><span class="o">])</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">Char</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="n">atEnd</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">reader</span>
      <span class="o">}</span>

      <span class="n">buffer</span> <span class="o">+=</span> <span class="n">reader</span><span class="o">.</span><span class="n">first</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="n">end</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">escape</span><span class="o">.</span><span class="n">find</span><span class="o">(</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="n">buffer</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">end</span><span class="o">)).</span><span class="n">isEmpty</span> <span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="n">rest</span>          
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="n">readString</span><span class="o">(</span><span class="n">end</span><span class="o">,</span> <span class="n">escape</span><span class="o">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">rest</span><span class="o">,</span> <span class="n">tokens</span><span class="o">,</span> <span class="n">buffer</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
  </div>
<script type="text/javascript">
$(function() {
    var $navList = $("#nav-list"),
        $change = $(".title .change-link");
    
    $change.click(function() { $navList.toggleClass("hidden") });
});
</script>
</body>
</html>
